app.controller("GettingStartedCtrl",["$scope","SettingsService",function(e,t){var n=t.get();e.helpUrl=n.account.support_website||"mailto:"+n.account.support_email}]),app.controller("InvoicesListCtrl",["$scope","$routeParams","$location","$q","GrowlsService","ApiService","SettingsService",function(e,t,n,r,i,o,c){e.exception={},e.resources={},e.resources.invoiceListUrl=o.buildUrl("/customers/me/invoices",c.get())}]),app.controller("InvoicesSetCtrl",["$scope","$routeParams","$location","ApiService","SettingsService","ConfirmService","GrowlsService",function(e,t,n,r,i,o,c){e.invoice={},e.payment={},e.exception={},e.count={},e.count.payments=0,e.count.refunds=0,e.resources={},e.currencies=i.get().account.currencies,e.params={expand:"customer.payment_methods,options,payments.payment_method,items.subscription_terms,subscription",formatted:!0},e.url=r.buildUrl("/invoices/"+t.id,i.get()),e.resources.paymentListUrl=e.url+"/payments",e.resources.refundListUrl=e.url+"/refunds",r.getItem(e.url,e.params).then(function(t){e.invoice=t,e.successful_payment=_.findWhere(e.invoice.payments.data,{success:!0})},function(t){e.exception.error=t,window.scrollTo(0,0)}),e.send=function(){r.set(null,e.url+"/send").then(function(t){c.addGrowl({id:"invoice_sent",type:"success",email:e.invoice.customer.email})},function(t){e.exception.error=t,window.scrollTo(0,0)})},e.downloadPdf=function(){r.getItemPdf(e.url).then(function(t){var n=new Blob([t],{type:"application/pdf"});saveAs(n,"Invoice_"+e.invoice.invoice_id+".pdf")},function(t){e.exception.error=t,window.scrollTo(0,0)})},e.changeCurrency=function(){var t={currency:e.invoice.currency};return r.set(t,e.url,e.params).then(function(t){e.invoice=t},function(t){e.exception.error=t,window.scrollTo(0,0)})}}]),app.controller("NotificationsListCtrl",["$scope","$routeParams","$location","$q","GrowlsService","ApiService",function(e,t,n,r,i,o){e.exception={},e.resources={},e.resources.notificationListUrl=o.buildUrl("/notifications")}]),app.controller("NotificationsViewCtrl",["$scope","$routeParams","ApiService","GrowlsService","$sce","SettingsService",function(e,t,n,r,i,o){e.notification={},e.exception={},e.url=n.buildUrl("/notifications/"+t.id,o.get()),e.previewUrl=null,e.showResend=!1;var c={expand:"customer",hide:"data"};n.getItem(e.url,c).then(function(t){e.notification=t,e.previewUrl=i.trustAsResourceUrl("app/pages/notifications/preview/index.html?notification_id="+t.notification_id),e.email=t.customer.email},function(t){e.exception.error=t,window.scrollTo(0,0)}),e.resend=function(t){if(!t.$invalid){var i={destination:e.email};n.set(i,e.url+"/resend",{show:"notification_id"}).then(function(t){r.addGrowl({id:"notification_resend",email:e.email,type:"success"}),e.showResend=!1},function(t){e.exception.error=t,window.scrollTo(0,0)})}}}]),app.controller("NotificationsPreviewCtrl",["$scope","$routeParams","ApiService","SettingsService",function(e,t,n,r){e.notification={},e.exception={},e.url=n.buildUrl("/notifications/"+t.id,r.get());var i={show:"body"};n.getItem(e.url,i).then(function(t){e.notification=t},function(t){e.exception.error=t,window.scrollTo(0,0)})}]),app.controller("OrdersListCtrl",["$scope","$routeParams","$location","$q","GrowlsService","ApiService","SettingsService",function(e,t,n,r,i,o,c){e.exception={},e.resources={},e.resources.orderListUrl=o.buildUrl("/customers/me/orders",c.get()),e.functions={},e.functions.toItemCsv=function(e){if(e&&e.items){var t=_.pluck(e.items,"name"),n=t.join(", ");return n}}}]),app.controller("OrdersViewCtrl",["$scope","$routeParams","ApiService","ConfirmService","GrowlsService","SettingsService",function(e,t,n,r,i,o){e.order={},e.payment={},e.exception={},e.count={},e.count.shipments=0,e.resources={},e.url=n.buildUrl("/orders/"+t.id,o.get()),e.resources.shipmentListUrl=e.url+"/shipments",e.resources.paymentListUrl=e.url+"/payments",e.resources.refundListUrl=e.url+"/refunds",e.resources.notificationListUrl=e.url+"/notifications";var c={expand:"customer,payment.response_data,payment.payment_method,payment.gateway,payment.refunds,items.product,items.subscription,items.subscription_terms,items.download.file,items.license.license_service,shipments",hide:"items.product.images,items.license.license_service.configuration",formatted:!0};n.getItem(e.url,c).then(function(t){e.order=t,e.showShipping=!1,_.each(e.order.items,function(t){t.license&&(t.license.renderedHtml="<strong>"+t.license.label+"</strong><br>"+t.license.html,t.license.instructions&&(e.renderedLicenseHtml+="<br><br>"+t.license.instructions)),"physical"==t.type&&(e.showShipping=!0)})},function(t){e.exception.error=t,window.scrollTo(0,0)}),e.downloadPdf=function(){n.getItemPdf(e.url).then(function(t){var n=new Blob([t],{type:"application/pdf"});saveAs(n,"Order_"+e.order.order_id+".pdf")},function(t){e.exception.error=t,window.scrollTo(0,0)})}}]),app.controller("PaymentsViewCtrl",["$scope","$routeParams","ApiService","ConfirmService","GrowlsService","SettingsService",function(e,t,n,r,i,o){e.payment={},e.exception={},e.fee_currency=null,e.currencyType="transaction",e.resources={},e.data={refunds:[]},e.refundParams={show:"refund_id,date_created,date_modified,status,success,total,subtotal,currency,shipping,tax"},e.prefs={},e.prefs.loadRefundDetails=!1,e.url=n.buildUrl("/payments/"+t.id,o.get()),e.resources.notificationListUrl=e.url+"/notifications",e.refundListUrl=e.url+"/refunds";var c={expand:"customer,payment_method,response_data,gateway,fees,commissions,order,invoice,refunds.items,cart"};n.getItem(e.url,c).then(function(t){e.payment=t},function(t){e.exception.error=t,window.scrollTo(0,0)})}]),app.controller("PaymentMethodsListCtrl",["$scope","$routeParams","$location","$q","GrowlsService","ApiService","SettingsService",function(e,t,n,r,i,o,c){e.exception={},e.resources={},e.resources.paymentMethodListUrl=o.buildUrl("/customers/me/payment_methods",c.get()),e.functions={},e.functions.getPaymentImageName=function(e){if(e)return"credit_card"==e.type?(e.data.type.toLowerCase()+".png").replace(" ","_"):(e.type.toLowerCase()+".png").replace(" ","_")}}]),app.controller("PaymentMethodsSetCtrl",["$scope","$routeParams","$location","ApiService","SettingsService","ConfirmService","GrowlsService","GeographiesService",function(e,t,n,r,i,o,c,s){e.paymentMethod={data:{billing_address:{}}},e.countries={},e.exception={},e.update=!1,e.add=!0,e.params="",e.geo=s,e.countries=e.geo.getGeographies().countries,e.us_states=e.geo.getGeographies().us_states,e.ca_provinces=e.geo.getGeographies().ca_provinces,e.au_states=e.geo.getGeographies().au_states,e.countries=_.sortBy(e.countries,"name"),t.id?(e.url=r.buildUrl("/customers/me/payment_methods/"+t.id,i.get()),e.add=!1,e.update=!0,r.getItem(e.url,e.params).then(function(t){e.paymentMethod=t},function(t){e.exception.error=t,window.scrollTo(0,0)})):(e.add=!0,e.update=!1),e.addPaymentMethod=function(){return e.form.$invalid?void window.scrollTo(0,0):(e.paymentMethod.type="credit_card",void r.set(e.paymentMethod,r.buildUrl("/customers/me/payment_methods",i.get())).then(function(e){c.addGrowl({id:"add_success",name:e.data.label||data.type,type:"success",payment_method_id:e.payment_method_id,url:"#/payment_methods/"+e.payment_method_id+"/edit"}),utils.redirect(n,"/payment_methods")},function(t){e.exception.error=t,window.scrollTo(0,0)}))},e.updatePaymentMethod=function(){return e.exception.error=null,e.form.$invalid?void window.scrollTo(0,0):void r.set(e.paymentMethod,e.url).then(function(e){c.addGrowl({id:"edit_success",name:e.data.label||e.type,type:"success",payment_method_id:e.payment_method_id,url:"#/payment_methods/"+e.payment_method_id+"/edit"}),utils.redirect(n,"/payment_methods")},function(t){window.scrollTo(0,0),e.exception.error=t})},e.confirmCancel=function(){var t={id:"changes_lost"};t.onConfirm=function(){utils.redirect(n,"/payment_methods")},o.showConfirm(e,t)},e.confirmDelete=function(){var t={id:"delete"};t.onConfirm=function(){e.removePaymentMethod()},o.showConfirm(e,t)},e.removePaymentMethod=function(){r.remove(e.paymentMethod.url).then(function(t){c.addGrowl({id:"delete_success",name:e.paymentMethod.data.label||e.paymentMethod.type,type:"success"}),utils.redirect(n,"/payment_methods")},function(t){window.scrollTo(0,0),e.exception.error=t})},e.getPaymentImageName=function(e){if(e)return"credit_card"==e.type?(e.data.type.toLowerCase()+".png").replace(" ","_"):(e.type.toLowerCase()+".png").replace(" ","_")}}]),app.controller("CustomersViewCtrl",["$scope","$routeParams","$location","GrowlsService","ApiService","ConfirmService","GeographiesService","SettingsService",function(e,t,n,r,i,o,c,s){e.customer={},e.billing_address={},e.shipping_address={},e.resources={},e.edit=!1,e.exception={},e.credentials={},e.url=i.buildUrl("/customers/me",s.get()),i.getItem(e.url).then(function(t){e.customer=t,e.credentials.username=t.username,e.payment_methods=t.payment_methods},function(t){e.exception.error=t,window.scrollTo(0,0)}),e.setCredentials=function(){e.exception.error=null,i.set(e.credentials,e.url).then(function(t){e.customer=t,r.addGrowl({id:"credentials_saved",type:"success"}),e.editCredentials=!1},function(t){e.exception.error=t,window.scrollTo(0,0)})}}]),app.controller("RefundsViewCtrl",["$scope","$routeParams","ApiService","ConfirmService","GrowlsService","SettingsService",function(e,t,n,r,i,o){e.refund={},e.exception={},e.fee_currency=null,e.items=[],e.currencyType="transaction",e.resources={},e.prefs={},e.prefs.loadRefundDetails=!1,e.url=n.buildUrl("/refunds/"+t.id,o.get()),e.resources.notificationListUrl=e.url+"/notifications";var c={expand:"payment,customer,payment_method,gateway,fees,commissions,order,refunds.items"};n.getItem(e.url,c).then(function(t){e.refund=t,null!=t.order&&(e.items=t.order.items)},function(t){e.exception.error=t,window.scrollTo(0,0)})}]),app.controller("SubscriptionsListCtrl",["$scope","$routeParams","$location","$q","GrowlsService","ApiService","SettingsService",function(e,t,n,r,i,o,c){e.exception={},e.resources={},e.resources.subscriptionListUrl=o.buildUrl("/customers/me/subscriptions",c.get())}]),app.controller("SubscriptionsViewCtrl",["$scope","$routeParams","$location","GrowlsService","ApiService","SettingsService","ConfirmService","$timeout",function(e,t,n,r,i,o,c,s){function u(e,t,n,r){return{product_id:e.product_id,reference_price:e.price,reference_discount:0,discount_apply_count:t.discount_apply_count,reference_currency:t.reference_currency,quantity:t.quantity,name:e.name,subscription_plan:n,subscription_terms:r,formatted:{reference_price:e.formatted.price}}}function a(t){var n={product_id:t.product_id,reference_price:t.reference_price,reference_discount:t.reference_discount,reference_currency:t.reference_currency,quantity:t.quantity,discount_apply_count:t.discount_apply_count,apply_immediately:t.apply_immediately};return n.reference_price||delete n.reference_price,n.reference_discount||delete n.reference_discount,n.quantity||(n.quantity=0),e.model.apply_unlimited&&(n.discount_apply_count=null),n}function d(e){_.each(e.items,function(e){var t=[];if(e.change_at_current_period_end){var n=e.change_at_current_period_end;if(e.item_id!=n.item_id&&t.push({name:"Product",from:e.name+" ("+e.item_id+")",to:n.name+" ("+n.item_id+")"}),e.reference_price!=n.reference_price&&t.push({name:"Price",from:e.formatted.reference_price+" "+e.reference_currency,to:n.formatted.reference_price+" "+n.reference_currency}),e.reference_discount!=n.reference_discount&&t.push({name:"Discount",from:e.formatted.reference_discount+" "+e.reference_currency,to:n.formatted.reference_discount+" "+n.reference_currency}),e.reference_currency!=n.reference_currency&&t.push({name:"Currency",from:e.reference_currency,to:n.reference_currency}),e.quantity!=n.quantity&&t.push({name:"Quantity",from:e.quantity,to:n.quantity}),e.discount_apply_count!=n.discount_apply_count){var r=e.discount_apply_count||"unset",i=n.discount_apply_count||"unlimited";t.push({name:"Times to apply the discount",from:r,to:i})}}t.length>0&&(e.change_summary=t)})}function l(t){var n={expand:f,formatted:!0},r=e.url+"/items/"+t.item_id+"/change_at_current_period_end";i.remove(r,n).then(function(n){t=n,d(n.subscription),e.model.subscription=n.subscription},function(t){window.scrollTo(0,0),e.exception.error=t})}function p(e){return delete e.reference_discount,delete e.discount_apply_count,delete e.reference_price,delete e.reference_currency,delete e.apply_immediately,e}e.exception={},e.payment_method=null,e.invoices={},e.model={},e.model.subscription={},e.resources={},e.count={},e.count.invoices=0,e.url=i.buildUrl("/subscriptions/"+t.id,o.get()),e.allCurrencies=JSON.parse(localStorage.getItem("payment_currencies")),e.allowCancel=o.get().account.allow_customer_subscription_cancel,e.resources.invoiceListUrl=e.url+"/invoices";var m="subscription_plan,customer.payment_methods,items.subscription_terms,items.subscription_plan,items.product",f="subscription.subscription_plan,subscription.customer.payment_methods,subscription.items.subscription_terms,subscription.items.subscription_plan,subscription.items.product";i.getItem(e.url,{expand:m,formatted:!0},{formatted:!0}).then(function(t){d(t),e.model.subscription=t;var n=_.find(JSON.parse(localStorage.getItem("payment_currencies")),function(e){return e.code==t.currency});e.currencies=[n],_.each(t.items,function(n){if(n.reference_currency!=t.currency){var r=_.find(JSON.parse(localStorage.getItem("payment_currencies")),function(e){return e.code==n.reference_currency});null==_.find(e.currencies,function(e){return e.code==r.code})&&e.currencies.push(r)}}),e.currencies=_.uniq(e.currencies)},function(t){e.exception.error=t,window.scrollTo(0,0)}),e.uncancel=function(){var t={cancel_at_current_period_end:!1};i.set(t,e.url+"/uncancel",{expand:m,formatted:!0}).then(function(t){d(t),e.model.subscription=t},function(t){e.exception.error=t,window.scrollTo(0,0)})},e.uncancelItem=function(t){i.set(null,t.url+"/uncancel",{expand:f,formatted:!0}).then(function(t){d(t.subscription),e.model.subscription=t.subscription},function(t){e.exception.error=t,window.scrollTo(0,0)})},e.setEdit=function(t){e.edit=!0,e.editing=t.item_id;var n={product_id:t.product_id,reference_price:t.reference_price,reference_discount:t.reference_discount,discount_apply_count:t.discount_apply_count,reference_currency:t.reference_currency,quantity:t.quantity,name:t.name,subscription_plan:e.model.subscription.subscription_plan,subscription_terms:t.subscription_terms,formatted:t.formatted};e.change_items=[n],n.discount_apply_count?e.model.apply_unlimited=!1:e.model.apply_unlimited=!0,e.selectItem(n),i.getItem(t.url,{expand:"product.subscription_plan,product.subscription_change_products.subscription_plan,product.subscription_term_change_products.subscription_plan,product.subscription_change_products.subscription_terms,product.subscription_term_change_products.subscription_terms",formatted:!0,currency:t.reference_currency}).then(function(t){_.each(t.product.subscription_change_products.data,function(n){e.change_items.push(u(n,t,n.subscription_plan,n.subscription_terms))}),_.each(t.product.subscription_term_change_products.data,function(n){e.change_items.push(u(n,t,n.subscription_plan,n.subscription_terms))})},function(t){e.exception.error=t,window.scrollTo(0,0)})},e.cancelEdit=function(){e.edit=!1,e.editing=null,e.selected=null,e.preview=null},e.isEditing=function(t){return e.editing==t.item_id},e.selectItem=function(t){t.apply_immediately=!1,e.selected=t,e.preview=null},e.isSelected=function(t){return e.selected.product_id==t.product_id},e.updateItem=function(t){var n=a(e.selected);n.date_effective=e.date_effective;var o={expand:f,formatted:!0},c=e.url+"/items";e.selected.product_id==t.product_id?c+="/"+t.item_id:o.remove_item_id=t.item_id,n=p(n),i.set(n,c,o).then(function(n){t=n,r.addGrowl({id:"edit_success_no_link",type:"success"}),e.preview=null,e.editing=null,d(n.subscription),e.model.subscription=n.subscription},function(t){window.scrollTo(0,0),e.exception.error=t})},e.previewChanges=function(t){e.exception&&e.exception.error&&(e.exception.error=null);var n=a(e.selected),r={formatted:!0},o=e.url+"/items";n.product_id==t.product_id?o+="/"+t.item_id+"/preview":(o+="/preview",r.remove_item_id=t.item_id),n=p(n),i.set(n,o,r).then(function(t){t.name=e.selected.name,e.preview=t,e.date_effective=t.date_effective},function(t){window.scrollTo(0,0),e.exception.error=t})},e.getSubscriptionInfo=function(e){var t=e.billing_interval_description;return e.trial_interval_description&&(t+=" with trial"),t},e.$watch("selected",function(t,n){t!=n&&(e.preview=null)},!0),e.confirmRemoveChanges=function(t){var n={id:"remove_changes"};n.onConfirm=function(){l(t)},c.showConfirm(e,n)}}]),$("document").ready(function(){function e(e){return document.cookie.length>0&&(c_start=document.cookie.indexOf(e+"="),c_start!=-1)?(c_start=c_start+e.length+1,c_end=document.cookie.indexOf(";",c_start),c_end==-1&&(c_end=document.cookie.length),unescape(document.cookie.substring(c_start,c_end))):""}var t=e("token"),n=utils.getPageQueryParameters(),r="/api/v1/invoices/"+n.invoice_id+"/links";n.invoice_id&&$.ajax({type:"POST",url:r,beforeSend:function(e){e.setRequestHeader("Authorization","Bearer "+t)},success:function(e){window.location=e.link_url}})}),$("document").ready(function(){function e(e){return document.cookie.length>0&&(c_start=document.cookie.indexOf(e+"="),c_start!=-1)?(c_start=c_start+e.length+1,c_end=document.cookie.indexOf(";",c_start),c_end==-1&&(c_end=document.cookie.length),unescape(document.cookie.substring(c_start,c_end))):""}var t=e("token"),n=utils.getPageQueryParameters(),r="/api/v1/notifications/"+n.notification_id+"?show=body";n.notification_id&&$.ajax({type:"GET",url:r,beforeSend:function(e){e.setRequestHeader("Authorization","Bearer "+t)},success:function(e){document.open(),document.write(e.body),document.close()}})});